#!/usr/bin/env python
#
# ssh-trulia: Figure out hostnames without having to define each one by hand.
# Written to be used with the ssh ProxyCommand option, but structured that it can be imported.
# My ssh config is set to call this from the PATH.
#
#

import sys

subdomains = {
  'corp': {
    'hosts': ('consumer-tools', 'consumer-tools-stage', 'toolia', 'toolia-stage', 'dash', 'dash-stage'),
    'parent': 'trulia.com'
  },
  'sv2' : {
    'aliases': {
	  'fedev': 'webfedev1',
    },
    'hosts': ('fedev',),
    'parent': 'trulia.com'
  }
  # Other hosts are treated as sv2.trulia.com
}

def get_host_from_alias(host_arg):
  for subdomain, subdomain_info in subdomains.iteritems():
    hosts = subdomain_info['hosts']
    if host_arg in hosts:
      aliases = subdomain_info.get('aliases', {})
      host_final = aliases.get(host_arg, host_arg)

      parent = subdomain_info.get('parent')

      return '.'.join((host_final, subdomain, parent))

  return host_arg + '.sv2.trulia.com'

if __name__ == '__main__':
  if len(sys.argv) == 1:
    sys.stdout.write('')
    sys.exit(1)

  host_arg = sys.argv[1]
  if '.' in host_arg:
    # Account for fully-qualified hosts.
    sys.stdout.write(host_arg)
    sys.exit()

  host = get_host_from_alias(host_arg)
  sys.stdout.write(host)
